<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> SKY DODGE </title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* CHẶN CHIA ĐÔI MÀN HÌNH */
        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background: #000;
            touch-action: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: absolute;
            top: 0; left: 50%;
            transform: translateX(-50%); /* Luôn giữ game ở giữa chính xác */
            width: 100vw;
            height: 100vh;
            max-width: 500px;
            background: radial-gradient(circle, #1a1a2e, #000);
            overflow: hidden;
        }

        /* GIAO DIỆN */
        .ui { position: absolute; top: 20px; width: 100%; text-align: center; z-index: 200; pointer-events: none; }
        .red { color: #ff4d4d; font-weight: bold; font-size: 24px; margin: 5px 0; }
        .progress-bg { width: 70%; height: 12px; background: #333; margin: 0 auto; border-radius: 10px; overflow: hidden; }
        #bar { height: 100%; width: 0%; background: #4CAF50; transition: 0.1s; }

        #paddle {
            position: absolute; bottom: 100px; left: 50%;
            height: 18px; border-radius: 10px;
            transform: translateX(-50%); z-index: 100;
            box-shadow: 0 0 15px var(--glow);
        }

        .falling-item { position: absolute; width: 60px; z-index: 50; }

        #msg { 
            display: none; position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); width: 85%; max-width: 350px;
            background: rgba(0,0,0,0.95); border: 2px solid red; border-radius: 15px;
            padding: 20px; text-align: center; z-index: 300; color: #fff;
        }
        button { padding: 12px; margin: 5px 0; width: 100%; border-radius: 8px; border: none; font-weight: bold; font-size: 16px; }
    </style>
</head>
<body>

<div id="game-container">
    <div class="ui">
        <div style="color:white">⏱ <span id="timer">0</span>s</div>
        <div class="red">Khối lượng: <span id="num">0</span> / <span id="max-num">100</span></div>
        <div class="progress-bg"><div id="bar"></div></div>
    </div>
    
    <div id="paddle"></div>

    <div id="msg">
        <h2 style="color:red; margin:0">QUÁ TẢI RỒI!</h2>
        <p id="final-stats"></p>
        <p id="coin-stats" style="color:#ffeb3b"></p>
        <button style="background:#ff4d4d; color:white" onclick="location.reload()">CHƠI LẠI</button>
        <button style="background:#2196F3; color:white" onclick="location.href='index.html'">TRANG CHỦ</button>
    </div>
</div>

<script>
    // FIX ZOOM & CỬ CHỈ
    document.addEventListener('touchstart', e => { if(e.touches.length>1) e.preventDefault(); }, {passive:false});
    document.addEventListener('touchend', e => {
        const now = Date.now();
        if(now - (window.lastT || 0) < 300) e.preventDefault();
        window.lastT = now;
    }, false);

    const firebaseConfig = {
        apiKey: "AIzaSyBbdRgcZmqt5-ywPyssZ1C2CDoj11slDQs",
        authDomain: "sky-dodge-8f537.firebaseapp.com",
        databaseURL: "https://sky-dodge-8f537-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "sky-dodge-8f537",
        storageBucket: "sky-dodge-8f537.firebasestorage.app",
        messagingSenderId: "169224412363",
        appId: "1:169224412363:web:de0d018158d8b34e854f4e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), auth = firebase.auth();

    const paddle = document.getElementById('paddle'), container = document.getElementById('game-container');
    const cap = parseInt(localStorage.getItem('paddleCapacity')) || 100;
    const pW = localStorage.getItem('paddleWidth') || '130';

    paddle.style.width = pW.includes('px') ? pW : pW + 'px';
    paddle.style.background = localStorage.getItem('paddleColor') || '#fff';
    document.getElementById('max-num').innerText = cap;

    let score = 0, time = 0, isOver = false, speed = 5;

    function move(x) {
        if(isOver) return;
        let r = container.getBoundingClientRect();
        let posX = x - r.left;
        let half = paddle.offsetWidth / 2;
        paddle.style.left = Math.max(half, Math.min(posX, r.width - half)) + 'px';
    }

    window.addEventListener('mousemove', e => move(e.clientX));
    window.addEventListener('touchmove', e => { e.preventDefault(); move(e.touches[0].clientX); }, {passive:false});

    const items = [
        { url: 'https://drive.google.com/thumbnail?id=1SGW0oc5yuw1WmArQ9GbNSQYBPbmXRWdi&sz=w200', w: 1 },
        { url: 'https://drive.google.com/thumbnail?id=17JZiAW3NHJvEg2iN679TdNB_DVlKN7xz&sz=w200', w: 2 },
        { url: 'https://drive.google.com/thumbnail?id=1IKc60y8Dn1ouIsFFzYw22oIcHM0Oxnjk&sz=w200', w: 0, fail: true }
    ];

    function spawn() {
        if(isOver) return;
        const info = items[Math.floor(Math.random() * items.length)];
        const img = document.createElement('img');
        img.src = info.url; img.className = 'falling-item';
        img.style.left = Math.random() * (container.offsetWidth - 60) + 'px';
        img.style.top = '-60px';
        container.appendChild(img);

        let y = -60;
        const loop = setInterval(() => {
            if(isOver) { img.remove(); clearInterval(loop); return; }
            y += speed; img.style.top = y + 'px';
            
            const p = paddle.getBoundingClientRect(), i = img.getBoundingClientRect();
            if(i.bottom > p.top && i.right > p.left && i.left < p.right && i.top < p.bottom) {
                if(info.fail) end("CHẠM VẬT CẤM!");
                else {
                    score += info.w;
                    document.getElementById('num').innerText = score;
                    document.getElementById('bar').style.width = (score/cap*100) + '%';
                    if(score >= cap) end("QUÁ TẢI RỒI!");
                }
                img.remove(); clearInterval(loop);
            }
            if(y > window.innerHeight) { img.remove(); clearInterval(loop); }
        }, 20);
        setTimeout(spawn, Math.max(300, 1000 - time * 10));
    }

    function end(txt) {
        isOver = true;
        document.querySelector('#msg h2').innerText = txt;
        document.getElementById('final-stats').innerText = `Thời gian: ${time}s`;
        document.getElementById('msg').style.display = 'block';
        save();
    }

    async function save() {
        const u = auth.currentUser;
        if(u) {
            await db.ref('users/'+u.uid+'/coins').transaction(c => (c||0) + time);
            document.getElementById('coin-stats').innerText = `+${time} Xu đã nhận!`;
        }
    }

    auth.onAuthStateChanged(u => { 
        if(u) { 
            spawn(); 
            setInterval(() => { if(!isOver) { time++; document.getElementById('timer').innerText = time; if(time%5==0) speed+=0.5; } }, 1000);
        } else location.href = 'index.html';
    });
</script>
</body>
</html>
