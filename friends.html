<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bạn Bè - SKY DODGE</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .status-dot.offline { color: #757575; } /* Màu xám cho offline */
.status-dot.online { color: var(--success); } /* Màu xanh cho online */
        :root { --primary: #5d5dff; --bg: #1a1a2e; --card: #2a2a4a; --success: #4CAF50; --danger: #ff4d4d; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; overflow: hidden; }
        
        .header-title { text-align: center; font-size: 24px; font-weight: 800; color: white; margin-bottom: 25px; letter-spacing: 2px; }

        /* SEARCH BOX */
        .search-container { display: flex; gap: 10px; background: var(--card); border-radius: 50px; padding: 5px 5px 5px 20px; align-items: center; margin-bottom: 20px; }
        .search-container input { flex: 1; background: transparent; border: none; color: white; outline: none; font-size: 16px; }
        .btn-search { background: var(--primary); border: none; padding: 10px 25px; border-radius: 50px; color: white; font-weight: bold; cursor: pointer; }

        /* ACTION BUTTONS */
        .main-actions { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .action-button { background: var(--card); padding: 18px 20px; border-radius: 15px; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 15px; position: relative; }
        .action-button i { color: var(--primary); width: 25px; text-align: center; }
        .badge { background: var(--danger); color: white; font-size: 12px; padding: 2px 8px; border-radius: 10px; position: absolute; right: 20px; }

        /* LISTS */
        .list-box { flex: 1; overflow-y: auto; background: var(--card); border-radius: 20px; padding: 10px 15px; margin-bottom: 15px; }
        .list-label { text-align: center; font-size: 14px; color: #888; margin-bottom: 10px; font-weight: bold; }
        .friend-item { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #3a3a60; }
        .friend-item:last-child { border-bottom: none; }
        .info { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 40px; height: 40px; background: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        .status-dot { color: var(--success); font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .btn-sm { border: none; padding: 8px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 12px; color: white; }
        
        .btn-back { background: #333; padding: 18px; border-radius: 50px; text-align: center; font-weight: bold; cursor: pointer; text-decoration: none; color: white; margin-top: auto; }
        
        #search-result { background: #3a3a60; border-radius: 15px; padding: 10px; margin-bottom: 15px; display: none; }
    </style>
</head>
<body>

    <div class="header-title">BẠN BÈ</div>

    <div class="search-container">
        <i class="fas fa-search" style="color:#888"></i>
        <input type="text" id="search-input" placeholder="Ô tìm kiếm bạn bè">
        <button class="btn-search" onclick="searchUser()">TÌM</button>
    </div>

    <div id="search-result"></div>

    <div class="main-actions">
        <div class="action-button"><i class="fas fa-plus"></i> Tạo phòng</div>
        <div class="action-button" onclick="location.href='room.html'"><i class="fas fa-plus"></i> Tạo phòng</div>
            <i class="fas fa-user-clock"></i> Lời mời kết bạn
            <span id="request-count" class="badge" style="display:none">0</span>
        </div>
    </div>

    <div id="request-box" class="list-box" style="display:none; border: 1px solid var(--primary); height: 200px;">
        <div class="list-label">LỜI MỜI ĐANG CHỜ</div>
        <div id="request-list-content"></div>
    </div>

    <div class="list-box">
        <div class="list-label">DANH SÁCH BẠN BÈ</div>
        <div id="friend-list-content"></div>
    </div>

    <div class="btn-back" onclick="location.href='index.html'">QUAY LẠI TRANG CHỦ</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBbdRgcZmqt5-ywPyssZ1C2CDoj11slDQs",
        authDomain: "sky-dodge-8f537.firebaseapp.com",
        databaseURL: "https://sky-dodge-8f537-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "sky-dodge-8f537",
        storageBucket: "sky-dodge-8f537.firebasestorage.app",
        messagingSenderId: "169224412363",
        appId: "1:169224412363:web:de0d018158d8b34e854f4e"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), auth = firebase.auth();
    let myId = "", myName = "";

    auth.onAuthStateChanged(user => {
        if (user) {
            myId = user.uid;
            // Theo dõi trạng thái kết nối
const myStatusRef = db.ref('/status/' + myId);
db.ref('.info/connected').on('value', (snap) => {
    if (snap.val() === false) return;
    // Khi thoát game/đóng tab
    myStatusRef.onDisconnect().set({ state: 'offline' }).then(() => {
        // Khi đang mở game
        myStatusRef.set({ state: 'online' });
    });
});
            db.ref('users/' + myId + '/name').once('value', s => myName = s.val());
            loadFriends();
            loadRequests();
        } else { location.href = 'auth.html'; }
    });

    async function searchUser() {
        const name = document.getElementById('search-input').value.trim();
        const resDiv = document.getElementById('search-result');
        if (!name) return;
        const snap = await db.ref('users').orderByChild('name').equalTo(name).once('value');
        resDiv.style.display = "block";
        resDiv.innerHTML = "";
        if (!snap.exists()) return resDiv.innerHTML = "<p style='text-align:center'>Không tìm thấy!</p>";
        
        snap.forEach(child => {
            if (child.key !== myId) {
                resDiv.innerHTML += `
                    <div class="friend-item" style="border:none">
                        <div class="info"><div class="avatar">${child.val().name[0]}</div><b>${child.val().name}</b></div>
                        <button class="btn-sm" style="background:var(--primary)" onclick="sendRequest('${child.key}', '${child.val().name}')">Kết bạn</button>
                    </div>`;
            }
        });
    }

    async function sendRequest(fId, fName) {
        await db.ref('friendRequests/' + fId + '/' + myId).set({ from: myName });
        alert("Đã gửi lời mời!");
        document.getElementById('search-result').style.display = "none";
    }

    function loadRequests() {
        db.ref('friendRequests/' + myId).on('value', snap => {
            const count = document.getElementById('request-count');
            const list = document.getElementById('request-list-content');
            list.innerHTML = "";
            if (!snap.exists()) return count.style.display = "none";
            
            let i = 0;
            snap.forEach(child => {
                i++;
                list.innerHTML += `
                    <div class="friend-item">
                        <b>${child.val().from}</b>
                        <div style="display:flex; gap:5px">
                            <button class="btn-sm" style="background:var(--success)" onclick="accept('${child.key}','${child.val().from}')">Đồng ý</button>
                            <button class="btn-sm" style="background:var(--danger)" onclick="reject('${child.key}')">Xóa</button>
                        </div>
                    </div>`;
            });
            count.innerText = i;
            count.style.display = "block";
        });
    }

    async function accept(fId, fName) {
        await db.ref('friends/' + myId + '/' + fId).set({ name: fName });
        await db.ref('friends/' + fId + '/' + myId).set({ name: myName });
        await db.ref('friendRequests/' + myId + '/' + fId).remove();
    }

    async function reject(fId) { await db.ref('friendRequests/' + myId + '/' + fId).remove(); }

    function loadFriends() {
    db.ref('friends/' + myId).on('value', snap => {
        const list = document.getElementById('friend-list-content');
        list.innerHTML = snap.exists() ? "" : "<p style='text-align:center;color:#666'>Chưa có bạn bè</p>";
        
        snap.forEach(child => {
            const friendId = child.key;
            const friendName = child.val().name;
            
            // Tạo một ID html riêng cho mỗi chấm trạng thái
            const statusId = `status-${friendId}`;
            
            list.innerHTML += `
                <div class="friend-item">
                    <div class="info">
                        <div class="avatar">${friendName[0]}</div>
                        <b>${friendName}</b>
                    </div>
                    <div id="${statusId}" class="status-dot offline">● Offline</div>
                </div>`;
            
            // Lắng nghe trạng thái Online của người bạn này
            db.ref('/status/' + friendId + '/state').on('value', s => {
                const dot = document.getElementById(statusId);
                if (!dot) return;
                if (s.val() === 'online') {
                    dot.innerText = "● Online";
                    dot.className = "status-dot online";
                } else {
                    dot.innerText = "● Offline";
                    dot.className = "status-dot offline";
                }
            });
        });
    });
}

    function toggleRequests() {
        const box = document.getElementById('request-box');
        box.style.display = box.style.display === 'none' ? 'block' : 'none';
    }
</script>
</body>
</html>
