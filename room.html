<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sky Dodge - Phòng chờ</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
body {
    margin: 0;
    background: #0f0c29;
    color: white;
    font-family: sans-serif;
}
.room {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    padding: 20px;
}
.slot {
    aspect-ratio: 1;
    border-radius: 15px;
    border: 2px dashed #555;
    display: flex;
    align-items: center;
    justify-content: center;
}
.slot img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 15px;
}
.host {
    border: 3px solid gold !important;
}
.controls {
    padding: 15px;
    display: flex;
    gap: 10px;
}
button {
    flex: 1;
    padding: 12px;
    font-weight: bold;
}
</style>
</head>

<body>

<div class="room">
    <div class="slot" id="s0"></div>
    <div class="slot" id="s1"></div>
    <div class="slot" id="s2"></div>
    <div class="slot" id="s3"></div>
    <div class="slot" id="s4"></div>
    <div class="slot" id="s5"></div>
</div>

<div class="controls">
    <button onclick="quitRoom()">Thoát phòng</button>
    <button id="startBtn" onclick="startGame()">Bắt đầu</button>
</div>

<script>
/* ================= FIREBASE ================= */

const firebaseConfig = {
    apiKey: "AIzaSyBbdRgcZmqt5-ywPyssZ1C2CDoj11slDQs",
    authDomain: "sky-dodge-8f537.firebaseapp.com",
    databaseURL: "https://sky-dodge-8f537-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sky-dodge-8f537",
    storageBucket: "sky-dodge-8f537.firebasestorage.app",
    messagingSenderId: "169224412363",
    appId: "1:169224412363:web:de0d018158d8b34e854f4e"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

let roomId = null;
let currentUser = null;

/* ================= AUTH ================= */

auth.onAuthStateChanged(user => {
    if (!user) {
        location.href = "auth.html";
        return;
    }

    currentUser = user;
    roomId = user.uid; // chủ phòng

    const avatar =
        user.photoURL ||
        `https://api.dicebear.com/7.x/bottts/png?seed=${user.uid}`;

    const roomRef = db.ref(`rooms/${roomId}`);

    // tạo phòng nếu chưa có
    roomRef.once("value").then(snap => {
        if (!snap.exists()) {
            roomRef.set({
                hostId: user.uid
            });
        }
    });

    // ghi player
    const playerRef = db.ref(`rooms/${roomId}/players/${user.uid}`);
    playerRef.set({
        name: user.displayName || "Người chơi",
        avatarUrl: avatar
    });

    // tự xoá khi mất kết nối
    playerRef.onDisconnect().remove();

    listenRoom();
});

/* ================= LISTEN ROOM ================= */

function listenRoom() {
    db.ref(`rooms/${roomId}`).on("value", snap => {
        const room = snap.val();
        if (!room || !room.players) {
            clearSlots();
            return;
        }

        renderPlayers(room.players, room.hostId);
        updateStartButton(room.hostId);
    });
}

/* ================= RENDER ================= */

function clearSlots() {
    for (let i = 0; i < 6; i++) {
        document.getElementById(`s${i}`).innerHTML = "";
        document.getElementById(`s${i}`).className = "slot";
    }
}

function renderPlayers(players, hostId) {
    clearSlots();

    let index = 0;
    Object.entries(players).forEach(([uid, p]) => {
        if (index >= 6) return;

        const slot = document.getElementById(`s${index}`);
        slot.innerHTML = `<img src="${p.avatarUrl}">`;

        if (uid === hostId) slot.classList.add("host");

        index++;
    });
}

/* ================= HOST LOGIC ================= */

function updateStartButton(hostId) {
    document.getElementById("startBtn").disabled =
        currentUser.uid !== hostId;
}

function handleHostLeave() {
    const roomRef = db.ref(`rooms/${roomId}`);

    roomRef.once("value").then(snap => {
        const room = snap.val();
        if (!room || !room.players) {
            roomRef.remove();
            return;
        }

        const uids = Object.keys(room.players);
        if (uids.length === 0) {
            roomRef.remove();
            return;
        }

        roomRef.update({
            hostId: uids[0]
        });
    });
}

/* ================= ACTIONS ================= */

function quitRoom() {
    const playerRef = db.ref(`rooms/${roomId}/players/${currentUser.uid}`);
    playerRef.remove().then(() => {
        db.ref(`rooms/${roomId}/hostId`).once("value").then(snap => {
            if (snap.val() === currentUser.uid) {
                handleHostLeave();
            }
        });
    });
}

function startGame() {
    alert("HOST bắt đầu game!");
}
</script>

</body>
</html>
